<!DOCTYPE html><html lang=en><head><meta charset=utf-8><meta http-equiv=content-type content="text/html; charset=utf-8"><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>.Net SQL Parsing - Using the TSqlParser library | A Place for Poor Examples</title><meta name=description content="What I've learned about software development. Don't expect too much."><meta name=keywords content="JavaScript, HTML, software, development, blog, examples, derby, cracking, coding, interview, CoffeeScript, node, express, .NET, C#, ASP.NET, Ember, Knockout, Angular, algorithms, analysis, analytics"><meta name=author content="Matt Blair"><meta name=google-site-verification content=pLaNxAD_C5VD6yWlQnX9ScKil_pSvI3lXz-9k4nOyYU><meta name=generator content="DocPad v6.79.4"><meta name=viewport content="width=device-width"><link rel="shortcut icon" href=/images/icons/favicon.ico><link rel=apple-touch-icon-precomposed sizes=144x144 href=/images/icons/apple-touch-icon-144-precomposed.png><link rel=apple-touch-icon-precomposed sizes=114x114 href=/images/icons/apple-touch-icon-114-precomposed.png><link rel=apple-touch-icon-precomposed sizes=72x72 href=/images/icons/apple-touch-icon-72-precomposed.png><link rel=apple-touch-icon-precomposed href=/images/icons/apple-touch-icon-57-precomposed.png><link rel=stylesheet href=/styles/twitter-bootstrap.css><link rel=stylesheet href=/styles/style.css><link rel=stylesheet href=/styles/mono-blue.css><link href=/atom.xml type=application/atom+xml rel=alternate title=Posts></head><body><div class="navbar navbar-inverse navbar-fixed-top"><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse><span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href="/">A Place for Poor Examples</a></div><div class="navbar-collapse collapse"><ul class="nav navbar-nav"><li typeof=sioc:Page about=/pages/about.html><a href=/pages/about.html property=dc:title>About</a></li><li typeof=sioc:Page about=/pages/posts.html><a href=/pages/posts.html property=dc:title>Posts</a></li><li typeof=sioc:Page about=/pages/hockey-stuff.html><a href=/pages/hockey-stuff.html property=dc:title>Hobbies</a></li></ul></div></div></div><div class=container><section id=content class=content><div class=row><div class=col-lg-9><article id=net-sql-parsing-using-the-tsqlparser-library class=post><div class=post-content><h1 class=post-title>.Net SQL Parsing - Using the TSqlParser library</h1><div class=post-date>Thu Nov 01 2012</div><p>A preface to this post: it is hard to find a free SQL Parser for .NET. There is a company that has a terrible library that they charge $150 bucks for. There are a couple of incomplete implementations done for school projects or for narrowly focused tasks. So if you want a no-strings attached free parser for SQL, you&#39;re out of luck. However, since most people who want a .NET parser are writing code on a Windows machine, and use Visual Studio, there is (lightly documented) hope: the TSqlParser library that ships with Visual Studio.</p><p>This is a fully featured parsing library for SQL Server SQL syntax. I&#39;m not sure about the support of other DB&#39;s SQL syntax, but I would imagine it&#39;s poor. On an x64 Windows machine, using Visual Studio 2010, the dll&#39;s which contain the TSqlParser library are located at: <code>C:\Program Files (x86)\Microsoft Visual Studio 10.0\VSTSDB</code> The class <code>TSql100Parser</code> in <code>Microsoft.Data.Schema.ScriptDom.Sql</code> gets you the parser for Sql Server 2008. To instantiate an instance of the <code>TSql100Parser</code> class, you have to supply the constructor with one parameter:</p><pre class=highlight><code class="hljs cs"> <span class=hljs-function><span class=hljs-keyword>public</span> <span class=hljs-title>TSql100Parser</span>(<span class=hljs-params><span class=hljs-keyword>bool</span> initialQuotedIdentifiers </span>)
</span></code></pre><p>The docs for this are better than trying to figure out what <code>initialQuotedIdentifiers</code> means:</p><blockquote><p>Specifies whether quoted identifier handling is on.</p></blockquote><p>I&#39;m guessing this has to do with declaring aliases for columns like this:</p><pre class=highlight><code class="hljs sql"><span class=hljs-keyword>select</span> bar <span class=hljs-keyword>as</span> <span class=hljs-string>'This is the alias for foo.bar'</span> <span class=hljs-keyword>from</span> tblFoo \<span class=hljs-comment>--instead of like this: select bar as [This is the alias for foo.bar] from tblFoo</span>
</code></pre><p>Using the parser is relatively simple. Once you reference the correct dll&#39;s in your project:</p><pre class=highlight><code class="hljs cs"> <span class=hljs-keyword>var</span> parser = <span class=hljs-keyword>new</span> TSql100Parser(<span class=hljs-literal>true</span>);
 <span class=hljs-keyword>var</span> script = parser.Parse(reader, <span class=hljs-keyword>out</span> errors) <span class=hljs-keyword>as</span> TSqlScript;
 <span class=hljs-keyword>foreach</span> (TSqlBatch batch <span class=hljs-keyword>in</span> script.Batches) {
  <span class=hljs-keyword>foreach</span> (TSqlStatement statement <span class=hljs-keyword>in</span> batch.Statements) {
    <span class=hljs-comment>//At this point, you have a collection of SQL Statements...</span>
    <span class=hljs-comment>//that can contain collections of SQL Statements...</span>
  }
}
</code></pre><p>My comment in the code above is to help you understand something about parsing SQL - almost every relationship is expressed as a tree, where something contains more of the same thing, and that thing may contain more of the same thing, or maybe not. Which means the easiest way to navigate the data is recursively. In other words, the Rules for using TSqlParser:</p><ol><li>LEARN TO LOVE THE RECURSION.</li><li>Refer to the Rules for using TSqlParser</li></ol><p>I&#39;ll give you an example scenario to show you what you&#39;re up against. One common scenario is searching your code for SELECT statements. Select statements can be contained in:</p><ul><li>Stored Procedures</li><li>If Statements</li><li>While Statements</li><li>BEGIN statements</li><li>Try/Catch Blocks</li></ul><p>I&#39;m sure I&#39;m missing some cases. So it&#39;s not as simple as saying &quot;give me all the statements that are select statements&quot;. Instead, you have to write something like:</p><pre class=highlight><code class="hljs cs">    <span class=hljs-function>function <span class=hljs-title>ProcessStatements</span>(<span class=hljs-params>statements</span>)

        <span class=hljs-title>foreach</span>(<span class=hljs-params>statement <span class=hljs-keyword>in</span> statements</span>)
            <span class=hljs-keyword>if</span> statement <span class=hljs-keyword>is</span> a Stored Procedure
               <span class=hljs-title>ProcessStatements</span>(<span class=hljs-params>statement.MyStatements</span>)
            <span class=hljs-keyword>if</span> statement <span class=hljs-keyword>is</span> an If Statement
               <span class=hljs-title>ProcessStatements</span>(<span class=hljs-params>statement.MyStatements</span>)
            <span class=hljs-keyword>if</span> statement <span class=hljs-keyword>is</span> a While Statement
               <span class=hljs-title>ProcessStatements</span>(<span class=hljs-params>statement.MyStatements</span>)
            <span class=hljs-keyword>if</span> statement <span class=hljs-keyword>is</span> a Select Statement
               <span class=hljs-title>ProcessSelect</span>(<span class=hljs-params> statement</span>)
</span></code></pre><p>So once you get your select statement (or your collection of select statements), how do you process them? Well unfortunately it&#39;s not straightforward. The <code>SelectStatement</code> class contains a field called <code>QueryExpression</code> - this field contains what kind of Select we&#39;re dealing with. As far as I can determine, there are three types of QueryExpressions:</p><ul><li>QuerySpecification</li></ul><p>This is an actual SELECT statement</p><ul><li>BinaryQueryExpression</li></ul><p>This is a UNION or similar expression between two SELECT statements</p><ul><li>QueryParenthesis</li></ul><p>This is a SELECT surrounded by parenthesis. In other words, a sub-select</p><p>So again, if you only want SELECT statements, you have to weed through the three types of QueryExpressions until you get to the underlying SELECT statements. So eventually you&#39;ll get to a list of QuerySpecifications (which represent the SELECT statements from your original query). Now here comes the good stuff: you can now weed through the SELECT fields programmatically and get out whatever information you want. Here are some of the fields on <code>QuerySpecification</code>:</p><pre class=highlight><code class="hljs routeros">|FromClauses|     Gets a list of <span class=hljs-keyword>FROM</span> clauses.|
|GroupByClause|   Gets <span class=hljs-keyword>or</span> sets a<span class=hljs-built_in> GROUP </span>BY clause.|
|HavingClause|    Gets <span class=hljs-keyword>or</span> sets a HAVING clause.|
|Into|            Gets <span class=hljs-keyword>or</span> sets the into table name.|
|SelectElements|  Gets a list of the selected columns <span class=hljs-keyword>or</span> <span class=hljs-builtin-name>set</span> variables.|
|TopRowFilter|    Gets <span class=hljs-keyword>or</span> sets the usage of the top row filter.|
|UniqueRowFilter| Gets <span class=hljs-keyword>or</span> sets the unique row<span class=hljs-built_in> filter </span>value.|
|WhereClause|     Gets <span class=hljs-keyword>or</span> sets a WHERE clause.|
</code></pre><p>Just tons of SELECT goodness. However, be warned: each of these fields contains lists with multiple subclasses. So more recursive diving if you want to get something very specific out of this select data. To get farther you might have to dive into the docs. <a href="http://msdn.microsoft.com/en-us/library/dd194286\(v=vs.90\">Link to MSDN Namespace Docs</a>.aspx)</p></div></article><footer><div id=disqus_thread></div><script type=text/javascript>
        var disqus_shortname = 'codetype';
        var disqus_identifier = 'net-sql-parsing-using-the-tsqlparser-library';
        var disqus_title = '.Net SQL Parsing - Using the TSqlParser library';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></footer></div><div class="col-lg-3 hidden-xs hidden-sm"><nav class=link-list><h3>Recent Posts</h3><div class=recent-post><a class=title href=/posts/20180115-manager-conference-links.html>Manager Conference Links</a></div><div class=recent-post><a class=title href=/posts/20181121-elasticsearch-perf-work.html>ElasticSearch Perf - Highlighter Edition</a></div><div class=recent-post><a class=title href=/posts/20180908-moment-js-alternatives.html>Moment.js alternatives</a></div><div class=recent-post><a class=title href=/posts/20180601-manager-readme.html>Manager READMEs</a></div><div class=recent-post><a class=title href=/posts/20180305-elasticsearch-sharding-work.html>ElasticSearch sharding work</a></div><div class=recent-post><a class=title href=/posts/20171229-engineering-management-classes.html>Engineering Management Classes</a></div></nav></div></div></section></div><script defer src=//cdnjs.cloudflare.com/ajax/libs/jquery/1.10.2/jquery.min.js></script><script defer src=//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js></script><script defer src=/vendor/twitter-bootstrap/dist/js/bootstrap.min.js></script><script defer src=/scripts/script.js></script><script defer src=/scripts/analytics.js></script></body></html>